---
title: Inspecting linkage reliability across bio data
output: html_notebook
---

I'm using eSense file count as a proxy for total sessions as there is currently one file per participant per wave. Matching Mirage to eSense is the first step of finding the correct window.

In theory, eSense and Mirage were collected on the same tablet, so the clock times should be compatible to at least the second.

```{r}
targets::tar_load(esense_meta)
targets::tar_load(mirage_windows)

# Using DuckDB
conn <- duckdb::dbConnect(duckdb::duckdb(), ":memory:")
duckdb::duckdb_register(conn, "esense", esense_meta)
duckdb::duckdb_register(conn, "mirage", mirage_windows)
```

Mirage comes in a stream of events. I have selected on the "play" and "baseline" events for now. They are processed using a stack to capture any nested events.

```{sql, connection = conn}
SELECT * FROM mirage USING SAMPLE 100;
```

```{sql, connection = conn}
WITH cte AS (
  SELECT DISTINCT mirage_pid
    , device
    , length_secs
    , start_time
    , end_time
  FROM esense 
  WHERE tz = 'bd'
)
SELECT * FROM cte USING SAMPLE 100;
```

Matching these sets is a bit of a mess. I decided to restrict the search window to $\pm$ 15 minutes.

```{sql, connection = conn}
WITH e AS (
  SELECT *
    , date_trunc('day', start_time) AS date
    , 'esense' AS source
  FROM esense
), m AS (
  SELECT *
    , date_trunc('day', start) AS date
    , 'mirage' AS source
  FROM mirage
), cte AS (
  SELECT source
    , mirage_pid
    , date
    , start_time AS start_t
    , end_time AS end_t
    , id AS row
  FROM e
  WHERE tz = 'ist'
  UNION BY NAME
  SELECT source
    , mirage_pid
    , date
    , "start" AS start_t
    , "end" AS end_t
    , id AS row
  FROM m
)
SELECT * 
FROM cte 
ORDER BY mirage_pid, date, source;
```

```{r, include=FALSE}
DBI::dbDisconnect(conn)
```





